<script src="//content.jwplatform.com/libraries/VFQcaWfi.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.js"></script>

<p>This demo uses an array of feed IDs to generate a tabbed playlist view. After all feeds are fetched with the JW Platform Delivery API, the view is created using a Handlebars.js template and the player is initialized with the first playlist. Context is maintained between the view and the player, even when individual videos are present in more than one playlist.</p>

<hr>

<div class="overflow-wrapper">
	<div class="demo-wrapper">
		<div id="player"></div>
		<div id="js-playlists" class="playlists"></div>
	</div>
</div>

<template id="js-playlist-template">
	<div class="playlist-switcher">
	{{#each this}}
		<a class="js-playlist-link playlist-link{{#if @first}} is-active{{/if}}" href="#" data-feedid="{{feedid}}">{{title}}</a>
	{{/each}}
	</div>
	{{#each this}}
	<div class="js-playlist playlist-container{{#if @first}} is-active{{/if}}" data-feedid="{{feedid}}">
		<ul class="playlist">
		{{#each playlist}}
			<li>
				<a class="js-video-link playlist-item" href="{{link}}" data-mediaid="{{mediaid}}">
					<img src="{{image}}" alt="{{title}}">
					<span>{{title}}</span>
				</a>
			</li>
		{{/each}}
		</ul>
	</div>
    {{/each}}
    <script>
    (function() {
  var apiRoute = 'https://cdn.jwplayer.com/v2/playlists/',
      feeds = [
        'a5NwFatL',
        '26hwc9Z4'
      ],
      playlistsTemplate = $('#js-playlist-template').html(),
      playerInstance;

  var setupPlayer = function(thisFeed) {
    // Initialize the player
    playerInstance = jwplayer('player').setup({
      playlist: thisFeed.playlist,
      visualplaylist: true,
      width: '60%'
    });

    // Change the highlighted item in the playlist when the video changes
    playerInstance.on('playlistItem', setActiveVideo);
  };

  var setActiveVideo = function(e) {
    var feedid = e.item.feedid,
        mediaid = e.item.mediaid;

    $('.js-video-link').removeClass('is-playing').filter(function() {
      return $(this).data('mediaid') === mediaid &&
        $(this).closest('.js-playlist').data('feedid') === feedid;
    }).addClass('is-playing');
  };

  var setActivePlaylist = function(e) {
    // Switch the visible playlist when its label is clicked
    var captured = $(this);
    e.preventDefault();

    if (!captured.hasClass('is-active')) {
      // Change the active playlist link
      $('.js-playlist-link').removeClass('is-active');
      captured.addClass('is-active');

      // Change the active visible playlist
      $('.js-playlist').removeClass('is-active').filter(function() {
        return $(this).data('feedid') === captured.data('feedid');
      }).addClass('is-active');
    }
  };

  var setPlayerVideo = function(e) {
    var captured = $(this),
        feedid = captured.closest('.js-playlist').data('feedid'),
        mediaid = captured.data('mediaid');

    // Gotta get the right playlist for this particular video link
    var currentPlaylist = feeds.filter(function(thisFeed) {
      return thisFeed.playlist.some(function(thisVideo) {
        return thisVideo.mediaid === mediaid && thisVideo.feedid === feedid;
      });
    }).shift().playlist;

    // Get the index of the video that matches this link's mediaid
    var videoIndex = currentPlaylist.findIndex(function(el) {
      return mediaid === el.mediaid;
    });

    e.preventDefault();

    // Only load this playlist if the player's current playlist is different
    if (currentPlaylist !== playerInstance.getPlaylist()) {
      playerInstance.load(currentPlaylist);
    }

    // Tell the player to play the video at this playlist index
    playerInstance.playlistItem(videoIndex);
  };

  var renderTemplate = function() {
    var playlistsContainer = $('#js-playlists');
    playlistsContainer.append(Handlebars.compile(playlistsTemplate)(feeds));

    // Create a delegate click event for playlist items
    playlistsContainer.on('click', '.js-video-link', setPlayerVideo);
    playlistsContainer.on('click', '.js-playlist-link', setActivePlaylist);
  };

  $.when.apply($, feeds.map(function(feedid) {
    // Use jQuery Deferreds to make sure all of the feeds are loaded before
    // rendering them or trying to initialize the player.
    var def = $.Deferred();
    $.ajax(apiRoute + feedid).done(function(data) {
      def.resolve(data);
    });
    return def.promise();
  })).then(function() {
    // replace the feeds array with all of the now-fetched feed objects
    feeds = $.makeArray(arguments);
    renderTemplate();
    setupPlayer(feeds[0]);
  });
})();
</script>
</template>
